# deployment.mdc

```markdown
# Deployment & Infrastructure Rules

This document incorporates directives from:
- **PRD & Tech Stack**: Next.js (Vercel) / React+Vite (Zeabur), FastAPI backend.
- **Database & Auth Rules**: Supabase (PostgreSQL + RLS), roles y JWT.
- **Implementation Plan**: CI/CD gates, control de entornos, auditorÃ­a de seguridad.
- **Cursorrules & Cursor Context**: Registro de variables, infraestructura y cambios en `cursor-context.md`.

---

## Environment Variables

### Next.js / Vercel
- `NEXT_PUBLIC_SUPABASE_URL=env://SUPABASE_URL`  
- `NEXT_PUBLIC_SUPABASE_ANON_KEY=env://SUPABASE_ANON_KEY`

### Vite / SPA
- `VITE_SUPABASE_URL=env://SUPABASE_URL`  
- `VITE_SUPABASE_ANON_KEY=env://SUPABASE_ANON_KEY`

### Backend (FastAPI)
- `OPENAI_API_KEY=env://OPENAI_KEY@vault` â†’ **solo backend**; jamÃ¡s en FE.  
- `SUPABASE_SERVICE_ROLE=env://SUPABASE_SERVICE_ROLE@vault` â†’ usar solo si imprescindible.  
- `DATABASE_URL=env://POSTGRES_URL`  
- `RAG_ENABLED=true|false`  
- `EXPORT_JOBS_ENABLED=true|false`  

ðŸ”‘ Variables con `@vault` deben provenir de un gestor seguro (no repositorios/cliente).

---

## Infrastructure

### Frontend
- **Next.js â†’ Vercel**: usar SSR/ISR en listados y reportes.  
- **React+Vite â†’ Zeabur**: build estÃ¡tico, distribuido en CDN.  

### Backend
- **Zeabur**: FastAPI + workers/jobs como entorno principal.  
- **AWS ECS (opcional)**: fallback para contenedorizaciÃ³n BE/FE.  

### Monitoring
- **Datadog RUM** (opcional en FE, sujeto a presupuesto).  
- **Supabase logs y mÃ©tricas DB**: base para alertas de latencia/errores.  

---

## CI/CD

### Tests Requeridos (gates)
- **ESLint/TypeScript** (FE).  
- **Auth flow test**: E2E â†’ login â†’ crear ticket â†’ listar (401/403/429).  
- **RAG smoke test**: si `RAG_ENABLED=true` â†’ indexar doc sintÃ©tico y ejecutar bÃºsqueda.  
- **Contract Check**: validar OpenAPI â†” implementaciÃ³n antes de release.  

### Release Tags
- Formato: `vX.Y.Z-sisgemec` (en lugar de `-esg`).  

---

## Enhancements (alineados a SISGEMEC)
- **Secure File Ingestion (MVP)**: permitir PDF/XLSX/CSV para exportes; adjuntos opcionales en tickets.  
  - ValidaciÃ³n de tamaÃ±o/mime.  
  - URLs firmadas.  
  - Sin PII.  
- **Enhanced Document Processing (opcional)**: OCR/tablas para manuales y documentos tÃ©cnicos.  
- **Reporting mejorado**: filtros, previsualizaciÃ³n y export CSV/XLSX/PDF (streaming o jobs).  
- **Seguridad**: Google OAuth opcional post-MVP; RLS estricto por rol (`Usuario`, `TÃ©cnico`, `Admin`).  
- **Audit Trail**: registrar uploads, ediciones, descargas y cambios de estado en `tickets_hist` o `audit_logs`.  
- **Arquitectura preparada**: metadatos por equipo/ticket y soporte RAG opcional para FAQ/bÃºsqueda.  

---

## New Features (opcionales)
- **Chatbot integrado** (`CHATBOT_ENABLED=true`):  
  - Asistente para bÃºsquedas/FAQ y guÃ­as de mantenimiento.  
  - Guardrails activos.  
  - Sin PII en prompts/respuestas.  
- **Visual Analytics Dashboard**: mÃ©tricas operativas (tickets por estado, tiempo de resoluciÃ³n, incidencias top) y export rÃ¡pida.  

---

## Adoption Notes
- Si se usa **Next.js** â†’ desplegar en **Vercel** (FE) y mantener **Zeabur** (BE).  
- Si se usa **Vite** â†’ FE tambiÃ©n puede ir a Zeabur/CDN.  
- Mantener **cost caps** para OpenAI y fallback de embeddings definidos en el Plan Financiero.  
- Documentar en `cursor-context.md` cualquier ajuste de variables o infraestructura para consistencia en generaciÃ³n de cÃ³digo.  

---

## Acceptance Checklist
- âœ” Variables de entorno documentadas y seguras (uso de `@vault` cuando aplique).  
- âœ” Infraestructura definida: FE en Vercel/Zeabur, BE en Zeabur (fallback AWS ECS opcional).  
- âœ” Monitoreo bÃ¡sico configurado (Supabase logs, alertas de latencia/errores).  
- âœ” CI/CD con lint, pruebas de flujo Auth, contract check y smoke tests de RAG (si aplica).  
- âœ” Export seguro de archivos (sin PII, URLs firmadas, validaciÃ³n mime/tamaÃ±o).  
- âœ” Reporting con filtros, previsualizaciÃ³n y export en CSV/XLSX/PDF.  
- âœ” AuditorÃ­a de operaciones crÃ­ticas en `tickets_hist` o `audit_logs`.  

---

## Open Questions
- Â¿Se define Next.js (Vercel) como frontend definitivo o se mantiene Vite (Zeabur)?  
- Â¿Se habilita Google OAuth en MVP o en fase posterior?  
- Â¿Se activa OCR/tablas en el MVP o solo si hay casos de uso?  
- Â¿Estrategia final de costos para OpenAI embeddings (fallback automÃ¡tico)?  
- Â¿PolÃ­tica de expiraciÃ³n para archivos en Storage y adjuntos de tickets?  

---

```