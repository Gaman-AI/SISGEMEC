<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SISGEMEC 2.0 — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS v2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#0b1220; color:#eef2ff; display:flex; min-height:100vh; align-items:center; justify-content:center; }
    .card { background:#111827; padding:24px; border-radius:14px; width:100%; max-width:380px; box-shadow: 0 10px 35px rgba(0,0,0,.35); }
    h1 { margin-top:0; font-size:20px; }
    label { display:block; margin: 12px 0 6px; font-size:14px; color:#c7d2fe; }
    input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#fff; }
    button { width:100%; margin-top:16px; padding:10px 12px; background:#4f46e5; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .error { color:#fecaca; font-size:13px; min-height:20px; margin-top:8px; }
    .hint { font-size:12px; color:#94a3b8; margin-top:10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Iniciar sesión</h1>

    <!-- Configuración de Supabase -->
    <script>
      // Estas credenciales deben estar en variables de entorno en producción
      const SUPABASE_URL = "https://xongkzaqnuyypkeycllg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvbmdremFxbnV5eXBrZXljbGxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NzYzNDYsImV4cCI6MjA3MTQ1MjM0Nn0.osiM1-UI5LEwep_wKPSEgikKpQpGnuCwMohE1b_4OpI";
    </script>

    <label for="email">Correo</label>
    <input id="email" type="email" placeholder="tu@correo.com" autocomplete="username" />

    <label for="password">Contraseña</label>
    <input id="password" type="password" placeholder="********" autocomplete="current-password" />

    <button id="loginBtn">Entrar</button>
    <div id="error" class="error"></div>
    <div class="hint">Tras login exitoso, se guarda el token en <code>localStorage["sb_token"]</code>.</div>
    
    <!-- Botón de logout (solo visible si hay sesión) -->
    <button id="logoutBtn" style="display: none; margin-top: 12px; background: #dc2626;">Cerrar Sesión</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);
    const btn = $("loginBtn");
    const logoutBtn = $("logoutBtn");
    const err = $("error");

    async function login() {
      err.textContent = "";
      btn.disabled = true;
      btn.textContent = "Iniciando sesión...";
      
      const email = $("email").value.trim();
      const password = $("password").value;

      // Validaciones básicas
      if (!email || !password) {
        err.textContent = "Por favor completa todos los campos";
        btn.disabled = false;
        btn.textContent = "Entrar";
        return;
      }

      try {
        // Usar la nueva API del backend
        const loginResp = await fetch("/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email, password })
        });

        if (!loginResp.ok) {
          const errorData = await loginResp.json();
          throw new Error(errorData.detail || "Error en la autenticación");
        }

        const loginData = await loginResp.json();
        
        // Guardar tokens
        localStorage.setItem("sb_token", loginData.access_token);
        localStorage.setItem("sb_refresh_token", loginData.refresh_token);
        localStorage.setItem("sb_user_id", loginData.user_id);
        localStorage.setItem("sb_user_email", loginData.email);
        localStorage.setItem("sb_user_role", loginData.role);

        // Redirección según rol
        const role = loginData.role.toUpperCase();
        if (role === "ADMIN") {
          window.location.href = "/static/admin.html";
        } else if (role === "RESPONSABLE") {
          window.location.href = "/static/responsable.html";
        } else if (role === "USER") {
          // Para usuarios básicos, redirigir a una página de bienvenida o dashboard básico
          window.location.href = "/static/responsable.html"; // Temporalmente al mismo lugar
        } else {
          err.textContent = `Rol no reconocido: ${role}. Contacta al administrador.`;
          btn.disabled = false;
          btn.textContent = "Entrar";
        }

      } catch (error) {
        console.error("Error en login:", error);
        err.textContent = error.message || "Error inesperado. Intenta de nuevo.";
        btn.disabled = false;
        btn.textContent = "Entrar";
      }
    }
    // Verificar si ya hay una sesión activa
    async function checkSession() {
      const token = localStorage.getItem("sb_token");
      if (token) {
        try {
          const sessionResp = await fetch("/auth/session", {
            headers: { "Authorization": `Bearer ${token}` }
          });
          
          if (sessionResp.ok) {
            const sessionData = await sessionResp.json();
            // Si la sesión es válida, redirigir según el rol
            const role = sessionData.role.toUpperCase();
            if (role === "ADMIN") {
              window.location.href = "/static/admin.html";
            } else if (role === "RESPONSABLE") {
              window.location.href = "/static/responsable.html";
            } else if (role === "USER") {
              window.location.href = "/static/responsable.html"; // Temporalmente al mismo lugar
            }
          } else {
            // Sesión inválida, limpiar localStorage
            localStorage.clear();
          }
        } catch (error) {
          console.error("Error verificando sesión:", error);
          localStorage.clear();
        }
      }
    }

    // Función de logout
    async function logout() {
      const token = localStorage.getItem("sb_token");
      if (token) {
        try {
          await fetch("/auth/logout", {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
          });
        } catch (error) {
          console.error("Error en logout:", error);
        }
      }
      
      // Limpiar localStorage y recargar
      localStorage.clear();
      window.location.reload();
    }

    // Event listeners
    btn.addEventListener("click", login);
    logoutBtn.addEventListener("click", logout);
    
    // ENTER para enviar
    document.addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
    
    // Verificar sesión al cargar la página
    checkSession();
  </script>
</body>
</html>

